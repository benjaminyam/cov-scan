# VARIABLES TO OVERRIDE
# COV_USER=admin
# COVERITY_PASSPHRASE=password_or_token
# COV_URL=https://coverity.company.com

COV_IDIR=${COV_IDIR-idir}
COV_BUILD_BUILD_CMD=${COV_BUILD_BUILD_CMD-""}
COV_CAPTURE_FLAGS=${COV_CAPTURE_FLAGS-""}
COV_ANALYZE_FLAGS=${COV_ANALYZE_FLAGS-""}

COV_ANALYZE_QUALITY=${COV_ANALYZE_QUALITY-1}
COV_ANALYZE_SECURITY=${COV_ANALYZE_SECURITY-1}
COV_ANALYZE_DISTRUST_ALL=${COV_ANALYZE_DISTRUST_ALL-0}
COV_ANALYZE_AUDIT_CHECKERS=${COV_ANALYZE_AUDIT_CHECKERS-0}

COV_PROJECT=${COV_PROJECT-$(basename `git rev-parse --show-toplevel`)}
COV_STREAM=${COV_STREAM-$COV_PROJECT-$(git rev-parse --abbrev-ref HEAD)}

# Commit Defects
stream_num=$(cov-manage-im --url $COV_URL --on-new-cert trust --mode streams --name $COV_STREAM --show -no-headers | wc -l) && {
	if [ $stream_num -eq 0 ]; then
		echo COV_SCAN: [COMMIT] STREAM DOES NOT EXIST ON CONNECT, CREATING PROJECT/STREAM \($COV_PROJECT/$COV_STREAM\)
		cov-manage-im --url $COV_URL --on-new-cert trust --mode streams  --add --set name:$COV_STREAM
		cov-manage-im --url $COV_URL --on-new-cert trust --mode projects --add --set name:$COV_PROJECT || true
		cov-manage-im --url $COV_URL --on-new-cert trust --mode projects --name $COV_PROJECT --update --insert stream:$COV_STREAM
	fi
	
	echo COV_SCAN: [COMMIT START] cov-commit-defects --dir $COV_IDIR --url $COV_URL --on-new-cert trust --stream $COV_STREAM
	time cov-commit-defects --dir $COV_IDIR --url $COV_URL --on-new-cert trust --stream $COV_STREAM
	echo COV_SCAN: [COMMIT END] cov-commit-defects --dir $COV_IDIR --url $COV_URL --on-new-cert trust --stream $COV_STREAM
} || {
	curl -kL $COV_URL &>/dev/null  && {
		echo COV_SCAN: [ERROR] USER AUTHENTICATION/AUTHORIZATION FAILURE, PLEASE ENSURE THAT USERNAME/PASSWORD IS CORRECT AND USER HAS COMMIT PERMISSION
		exit 1
	} || {
		echo COV_SCAN: [ERROR] CANNOT REACH CONNECT, PLEASE ENSURE THAT CONNECT SERVER IS RUNNING
		exit 1
	}
}
