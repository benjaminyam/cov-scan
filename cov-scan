cov_build_cmd="cov-build --dir idir"
build_cmd=""
capture_cmd=""
analysis_flags="--all"
#analysis_flags="--disable-default" #Security focused
security=1
audit_checkers=0
#cpu_cmd="cat /proc/cpuinfo | grep processor | wc -l"
cpu_cmd="nproc"

if [[ "$OSTYPE" == "darwin"* ]]; then
        cpu_cmd="sysctl -n machdep.cpu.thread_count"
fi


# Build Command
if [ $(ls | grep pom.xml | wc -l) -gt 0 ]; then
	build_cmd="mvn -T $($cpu_cmd) clean compile -DskipTests -Dmaven.test.skip=true"
	echo $cov_build_cmd $build_cmd
	$cov_build_cmd $build_cmd
fi
if [ $(ls | grep go.mod | wc -l) -gt 0 ]; then
	go clean
	build_cmd="go build"
	echo $cov_build_cmd $build_cmd
        $cov_build_cmd $build_cmd

	$cov_build_cmd $build_cmd
fi
if [ $(ls | grep .sln | wc -l) -gt 0 ]; then
	dotnet clean
	build_cmd="dotnet build"
	echo $cov_build_cmd $build_cmd
        $cov_build_cmd $build_cmd
fi
if [ $(ls | grep gradle.properties | wc -l) -gt 0 ]; then
	build_cmd="gradle clean build"
	echo $cov_build_cmd $build_cmd
	gradle stop
        $cov_build_cmd $build_cmd
fi

# Capture Command
if [ $(ls | grep package.json | wc -l) -gt 0 ]; then
	npm install
	capture_cmd="--project-dir ."
elif [ $(find . -type f \( -name "*.html" -or -name "*.js" -or -name "*.rb" -or -name "*.py" -or -name "*.ts" -or -name "*.php" \) | wc -l) -gt 0 ]; then
        capture_cmd="--source-dir ."
fi

if [ -n "$capture_cmd" ]; then	
        echo cov-capture --dir idir $capture_cmd
	cov-capture --dir idir $capture_cmd
fi

# Analysis Command
if [ $audit_checkers -eq 1 ]; then
        analysis_flags+=" --enable-audit-checkers"
fi

if [ $security -eq 1 ]; then
	analysis_flags+=" --webapp-security" 
fi

cov-analyze --dir idir --strip-path $(pwd) $analysis_flags
